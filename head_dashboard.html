<!DOCTYPE html>
<html lang="af">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Nexon Tutoring â€” Hoof Dashboard</title>
<style>
/* === NEUTRAL, HIGH-CONTRAST STYLE === */
body {
  margin: 0;
  font-family: "Inter", Segoe UI, Arial, sans-serif;
  background: #f5f5f5;
  color: #222;
}

.app {
  max-width: 1400px;
  margin: 20px auto;
  display: grid;
  grid-template-rows: auto 1fr auto;
  gap: 16px;
  padding: 0 16px 40px;
}

.top {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.brand .logo {
  font-weight: 800;
  font-size: 24px;
  letter-spacing: 1px;
  color: #222;
}

.brand .subtitle {
  font-size: 14px;
  color: #555;
}

.btn {
  padding: 10px 18px;
  border-radius: 12px;
  border: 1px solid #888;
  background: #e0e0e0;
  color: #222;
  cursor: pointer;
  font-weight: 600;
  transition: all 0.3s ease;
}

.btn:hover {
  background: #d5d5d5;
  box-shadow: none;
}

.layout {
  display: grid;
  grid-template-columns: 300px 1fr 380px;
  gap: 16px;
}

.panel {
  background: #fff;
  border-radius: 18px;
  border: 1px solid #ccc;
  padding: 16px;
  display: flex;
  flex-direction: column;
}

.panel-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 10px;
  font-weight: 600;
  font-size: 16px;
  color: #222;
}

.students-list, .sessions {
  overflow-y: auto;
  max-height: 60vh;
}

.student, .sess-item {
  background: #f0f0f0;
  margin-bottom: 10px;
  padding: 10px;
  border-radius: 12px;
  cursor: pointer;
  transition: 0.25s;
}

.student:hover, .sess-item:hover {
  background: #e2e2e2;
}

.student.active {
  border: 2px solid #555;
}

.input, select, textarea {
  width: 100%;
  padding: 10px;
  margin-top: 6px;
  border-radius: 12px;
  border: 1px solid #bbb;
  background: #fff;
  color: #222;
  font-size: 14px;
}

.input:focus, select:focus, textarea:focus {
  outline: none;
  border-color: #888;
  box-shadow: 0 0 5px rgba(0,0,0,0.2);
}

.full { width: 100%; }

.invoice-actions { display: flex; flex-direction: column; gap: 8px; margin-top: 10px; }

.invoice-hint {
  font-size: 12px;
  color: #555;
  margin-top: 6px;
}

.footer {
  text-align: center;
  font-size: 13px;
  color: #666;
  margin-top: 12px;
}

.modal-back {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.3);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 1000;
}

.modal {
  background: #fff;
  border-radius: 18px;
  border: 1px solid #ccc;
  padding: 24px;
  width: 520px;
  color: #222;
}

@media(max-width: 1100px){
  .layout {grid-template-columns:1fr;}
  .modal {width: 92%;}
}
</style>
</head>

<body>
<div class="app">
<header class="top">
  <div class="brand">
    <div class="logo">NEXON</div>
    <div class="subtitle">Sessie-Logger & Faktuur Bouer</div>
  </div>
  <div class="controls">
    <label class="btn filebtn">Laai studente.json op
      <input id="uploadStudents" type="file" accept="application/json" style="display:none">
    </label>
    <button id="sendAllInvoicesBtn" class="btn" style="background:rgba(212,175,55,0.15)">Stuur Alle Fakture</button>
    <button id="exportSessionsBtn" class="btn">Eksporteer sessies</button>
    <button id="logoutBtn" class="btn">Teken uit</button>
  </div>
</header>

<main class="layout">
<aside class="panel left">
  <div class="panel-header">
    <h3>Studente</h3>
    <button id="refreshBtn" class="btn small">Herlaai</button>
  </div>
  <div id="studentsList" class="students-list"></div>
  <div class="hint" style="font-size:12px;color:gray;margin-top:10px">Laai 'n <code>students.json</code> op om die databasis te vul.</div>
</aside>

<section class="panel middle">
  <div class="panel-header"><h3>Sessie-Logger</h3></div>
  <div id="selectedStudentArea" class="selected-area"></div>
  <div id="studentSessions" class="sessions"></div>
</section>

<aside class="panel right">
  <div class="panel-header"><h3>Faktuur Bouer</h3></div>
  <label>Student
    <select id="invoiceStudent" class="full"></select>
  </label>
  <div class="invoice-actions">
    <button id="downloadInvoiceBtn" class="btn full">Laai Faktuur af</button>
    <button id="sendInvoiceBtn" class="btn full">Stuur Faktuur per E-pos</button>
  </div>
  <div class="invoice-hint">Tariewe: Groep R230/uur, Individueel R340/uur, Kansellasie 50%</div>
</aside>
</main>

<!-- Replace your existing #invoice-summary div with this -->
<div id="invoice-summary" style="margin-top: 40px; padding: 20px; border-radius: 18px; background: rgba(15,15,15,0.85); border:1px solid rgba(212,175,55,0.3); color:#d4af37; display:flex; justify-content:space-around; align-items:center; flex-wrap:wrap;">
  <div style="text-align:center; margin:10px;">
    <div style="font-size:14px; opacity:0.7;">Totale Klasfooie</div>
    <div id="total-amount" style="font-size:22px; font-weight:700;">R0.00</div>
  </div>
  <div style="text-align:center; margin:10px;">
    <div style="font-size:14px; opacity:0.7;">Fakture Gestuur</div>
    <div id="sent-count" style="font-size:22px; font-weight:700;">0</div>
  </div>
  <div style="text-align:center; margin:10px;">
    <div style="font-size:14px; opacity:0.7;">Fakture Uitstaande</div>
    <div id="pending-count" style="font-size:22px; font-weight:700;">0</div>
  </div>
  <button id="refreshSummaryBtn" class="btn" style="margin-top:10px; flex-basis:100%;">Herlaai Opsomming</button>
</div>


<footer class="footer">
  Data word nou op die "Cloud" bediener gestoor.
</footer>
</div>

<div id="modalRoot"></div>

<script>
(() => {

/* ========================
   CONFIG & STATE (Unchanged)
=========================== */
const API_URL = 'http://localhost:3000'; 
const RATE_GROUP = 230;
const RATE_INDIVIDUAL = 340;
const CANCELLATION_FRACTION = 0.5;
const $ = id => document.getElementById(id);
const genId = () => `${Date.now()}_${Math.random().toString(36).slice(2,6)}`;
const fmt = n=>'R'+Number(n||0).toFixed(2);
const escapeHTML = s=>String(s||'').replace(/[&<>"]/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));

let students = [];
let sessions = [];
let selectedStudentId = null; 

const studentsList = $('studentsList');
const studentSessions = $('studentSessions');
const selectedStudentArea = $('selectedStudentArea');
const invoiceStudent = $('invoiceStudent');
const downloadInvoiceBtn = $('downloadInvoiceBtn');
const sendInvoiceBtn = $('sendInvoiceBtn');
const sendAllInvoicesBtn = $('sendAllInvoicesBtn');


/* ========================
   API FUNCTIONS (Unchanged)
=========================== */
async function refreshData() {
  try {
    const res = await fetch(`${API_URL}/api/data`);
    if(!res.ok) throw new Error("Netwerk fout");
    const data = await res.json();
    students = data.students || [];
    sessions = data.sessions || [];
    
    renderStudents();
    if(selectedStudentId) renderStudentSessions(selectedStudentId);
  } catch(err) {
    console.error("Connection error:", err);
    alert("Kon nie met die bediener koppel nie. Maak seker die bediener is aan.");
  }
}

async function saveSessionToCloud(sessionObj) {
  try {
    const res = await fetch(`${API_URL}/api/session`, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify(sessionObj)
    });
    const json = await res.json();
    if(json.success) {
      refreshData();
    } else {
      alert("Fout met stoor: " + json.error);
    }
  } catch(err) {
    alert("Kon nie bediener bereik nie om te stoor.");
  }
}

async function deleteSessionCloud(id) {
  try {
    await fetch(`${API_URL}/api/session/${id}`, { method: 'DELETE' });
    refreshData();
  } catch(err) {
    alert("Fout met verwydering.");
  }
}

async function uploadStudentsToCloud(studentArray) {
  try {
    const res = await fetch(`${API_URL}/api/students/sync`, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify(studentArray)
    });
    const json = await res.json();
    if(json.success) {
      alert("Studente suksesvol gelaai na die bediener!");
      refreshData();
    }
  } catch(err) {
    alert("Upload fout: " + err.message);
  }
}

/* ========================
      RENDER LOGIC (Unchanged)
=========================== */
function renderStudents(){
  studentsList.innerHTML='';
  renderInvoiceSelect();

  if(!students.length){
    studentsList.innerHTML='<div class="hint">Geen studente. Laai JSON op.</div>';
    return;
  }
  
  const sorted = [...students].sort((a,b) => a.name.localeCompare(b.name));

  sorted.forEach(s=>{
    const div=document.createElement('div');
    div.className='student';
    if(s.id === selectedStudentId) div.classList.add('active');
    
    div.innerHTML=`<div style="display:flex;justify-content:space-between;align-items:center">
      <div>
        <div style="font-weight:700;color:rgba(15,15,15,0.85)">${escapeHTML(s.name)}</div>
        <div style="font-size:13px;color:rgba(15,15,15,0.85)">Graad ${escapeHTML(s.grade||'-')}</div>
      </div>
      <div style="font-size:13px;color:rgba(15,15,15,0.85)">${sessions.filter(ss=>ss.studentId===s.id).length}</div>
    </div>`;
    div.onclick=()=>selectStudent(s.id);
    studentsList.appendChild(div);
  });
}

function renderInvoiceSelect(){
  const currentVal = invoiceStudent.value;
  invoiceStudent.innerHTML='<option value="">â€” kies student â€”</option>';
  students.forEach(s=>{
    const o=document.createElement('option');
    o.value=s.id;
    o.textContent=s.name;
    invoiceStudent.appendChild(o);
  });
  if(currentVal) invoiceStudent.value = currentVal;
}

function selectStudent(id){
  selectedStudentId = id;
  renderStudents(); 
  
  const st=students.find(x=>x.id===id);
  if(!st) return;

  selectedStudentArea.innerHTML=`
    <div style="display:flex;justify-content:space-between;align-items:center; margin-bottom:10px;">
      <div>
        <div style="font-weight:800; font-size:1.1em;">${escapeHTML(st.name)}</div>
        <div style="font-size:13px;color:rgba(15,15,15,0.85)">${st.parentEmail || 'Geen e-pos'}</div>
      </div>
      <div><button id="openLog" class="btn small">Log Sessie</button></div>
    </div>`;

  $('openLog').onclick=()=>openLogModal({studentId:id});
  renderStudentSessions(id);
}

function renderStudentSessions(studentId){
  studentSessions.innerHTML='';
  const list=sessions
    .filter(s=>s.studentId===studentId)
    .sort((a,b)=>new Date(b.datetime)-new Date(a.datetime));

  if(!list.length){
    studentSessions.innerHTML='<div class="hint">Geen sessies vir hierdie student nie.</div>';
    return;
  }

  list.forEach(s=>{
  const rate = s.mode==='Individueel'?RATE_INDIVIDUAL:RATE_GROUP;
  const total = s.cancelled?rate*CANCELLATION_FRACTION*s.hours:rate*s.hours;

  const div=document.createElement('div');
  div.className='sess-item';
  div.innerHTML=`
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div>
        <div style="font-weight:700;color:#000">${escapeHTML(s.subject)} â€” ${escapeHTML(s.mode)}</div>
        <div style="font-size:13px;color:rgba(0,0,0,0.7)">${new Date(s.datetime).toLocaleDateString()}</div>
      </div>
      <div style="text-align:right">
        <div style="font-weight:700;color:#000">${s.hours}h</div>
        <div style="font-size:13px;color:rgba(0,0,0,0.7)">${fmt(total)}</div>
      </div>
    </div>
    <div style="display:flex;justify-content:space-between;margin-top:6px; align-items:center;">
      <label style="color:rgba(0,0,0,0.6);font-size:13px; cursor:pointer;">
        <input type="checkbox" class="cancel-check" ${s.cancelled?'checked':''}> Kanselleer (50%)
      </label>
      <div style="gap:5px; display:flex;">
        <button class="btn small" style="padding:4px 8px; font-size:12px;" data-edit="${s.id}">Wysig</button>
        <button class="btn small" style="padding:4px 8px; font-size:12px;" data-del="${s.id}">X</button>
      </div>
    </div>`;

    const check = div.querySelector('.cancel-check');
    check.onchange = () => {
      const updatedSession = {...s, cancelled: check.checked};
      saveSessionToCloud(updatedSession);
    };

    div.querySelector('[data-edit]').onclick=()=>openLogModal(s);
    div.querySelector('[data-del]').onclick=()=>{
      if(confirm('Verwyder sessie?')) deleteSessionCloud(s.id);
    };

    studentSessions.appendChild(div);
  });
}

/* ========================
      ADD / EDIT MODAL (Unchanged)
=========================== */
function openLogModal(data){
  const isEdit=!!data.id;
  const modalBack=document.createElement('div'); modalBack.className='modal-back';
  const modal=document.createElement('div'); modal.className='modal';

  modal.innerHTML=`
    <h3>${isEdit?'Wysig':'Nuwe'} Sessie</h3>
    <label>Vak
      <select id="sessSubject" class="full">
        <option>Wiskunde</option>
        <option>Wetenskap</option>
        <option>Rekeningkunde</option>
        <option>Afrikaans</option>
        <option>Engels</option>
      </select>
    </label>

    <label>Modus
      <select id="sessMode" class="full">
        <option>Individueel</option>
        <option>Groep</option>
      </select>
    </label>

    <div style="display:flex; gap:10px;">
      <div style="flex:1"><label>Ure<input type="number" min="0.5" step="0.5" id="sessHours" class="full"></label></div>
      <div style="flex:1"><label>Datum<input type="date" id="sessDate" class="full"></label></div>
    </div>

    <label>Notas
      <textarea id="sessNotes" class="full" rows="2"></textarea>
    </label>

    <div style="margin-top:10px;text-align:right">
      <button id="saveSess" class="btn">Stoor</button>
      <button id="cancelSess" class="btn" style="border-color:transparent; color:#888;">Kanselleer</button>
    </div>`;

  modalBack.appendChild(modal); 
  document.body.appendChild(modalBack);

  // Set values
  if(isEdit){
    $('sessSubject').value=data.subject;
    $('sessMode').value=data.mode;
    $('sessHours').value=data.hours;
    $('sessDate').value=data.datetime;
    $('sessNotes').value=data.notes||'';
  } else {
    $('sessDate').value=new Date().toISOString().slice(0,10);
    $('sessHours').value=1;
  }

  $('cancelSess').onclick=()=>modalBack.remove();

  $('saveSess').onclick=()=>{
    const obj={
      id: isEdit ? data.id : genId(),
      studentId: data.studentId,
      subject: $('sessSubject').value,
      mode: $('sessMode').value,
      hours: Number($('sessHours').value),
      datetime: $('sessDate').value,
      notes: $('sessNotes').value,
      cancelled: isEdit ? data.cancelled : false
    };

    saveSessionToCloud(obj);
    modalBack.remove();
  };
}

/* ========================
     UPLOAD JSON (Unchanged)
=========================== */
$('uploadStudents').onchange = (e) => {
  const file = e.target.files[0]; 
  if (!file) return;
  const reader = new FileReader();
  reader.onload = ev => {
    try {
      const data = JSON.parse(ev.target.result);
      let list = [];
      
      if (data.students && Array.isArray(data.students)) {
        list = data.students;
      } else if (Array.isArray(data)) {
        list = data;
      }
      
      if(list.length > 0) {
        list = list.map(s => ({
            id: s.id || genId(),
            name: s.name,
            grade: s.grade,
            parentEmail: s.parentEmail
        }));
        uploadStudentsToCloud(list);
      } else {
        alert("Geen 'students' lys gevind in JSON nie.");
      }
    } catch(err){
      alert('Fout in JSON: ' + err.message);
    }
  };
  reader.readAsText(file);
};

/* ========================
     NEW & MODIFIED INVOICING LOGIC
=========================== */

// MODIFIED: Download button now hits the new server endpoint to trigger server-side generation/download
downloadInvoiceBtn.onclick = () => {
  const studentId = invoiceStudent.value;
  if (!studentId) return alert('Kies asseblief n student');
  
  // Triggers the server to generate, save, and stream the PDF back for download
  // This uses the server's download endpoint
  window.open(`${API_URL}/download-invoice/${studentId}`, '_blank');
};

// MODIFIED: Send button now hits the new server endpoint
sendInvoiceBtn.onclick = async () => {
  const studentId = invoiceStudent.value;
  if (!studentId) return alert("Kies asseblief 'n student");

  const st = students.find(s => s.id === studentId);
  if (!st || !st.parentEmail) return alert("Geen e-pos vir hierdie student");

  try {
    sendInvoiceBtn.disabled = true;
    sendInvoiceBtn.textContent = "Stuur...";

    const res = await fetch(`${API_URL}/send-invoice`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ studentId })
    });

    const json = await res.json();

    sendInvoiceBtn.disabled = false;
    sendInvoiceBtn.textContent = "Stuur Faktuur per E-pos";

    if (!json.success) return alert("Fout: " + json.error);

    alert("Faktuur gestuur!");

    // ðŸ”¥ Refresh the summary automatically
    updateInvoiceSummary();

  } catch (err) {
    sendInvoiceBtn.disabled = false;
    sendInvoiceBtn.textContent = "Stuur Faktuur per E-pos";
    alert("Kon nie bediener bereik nie.");
  }
};

// NEW: Bulk send button logic
sendAllInvoicesBtn.onclick = async () => {
  if (!confirm("Stuur AL die fakture nou?")) return;

  try {
    sendAllInvoicesBtn.disabled = true;
    sendAllInvoicesBtn.textContent = "Besig...";

    const res = await fetch(`${API_URL}/send-all-invoices`, {
      method: "POST",
      headers: { "Content-Type": "application/json" }
    });

    const json = await res.json();

    sendAllInvoicesBtn.disabled = false;
    sendAllInvoicesBtn.textContent = "Stuur Alle Fakture";

    if (!json.success) return alert("Fout: " + json.error);

    alert(`Sukses! ${json.sentCount} fakture gestuur.`);

    // ðŸ”¥ Refresh summary immediately
    updateInvoiceSummary();

  } catch (err) {
    sendAllInvoicesBtn.disabled = false;
    sendAllInvoicesBtn.textContent = "Stuur Alle Fakture";
    alert("Kon nie bediener bereik nie.");
  }
};

$('refreshBtn').onclick = refreshData;

$('exportSessionsBtn').onclick = () => {
  const blob=new Blob([JSON.stringify(sessions,null,2)],{type:'application/json'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=`sessies_backup_${new Date().toISOString().slice(0,10)}.json`; a.click();
};

$('logoutBtn').onclick = () => { if (confirm('Weet jy seker?')) window.location.href = 'index.html'; };

// START
refreshData();
})();
</script>
<script>
document.getElementById('refreshSummaryBtn').onclick = updateInvoiceSummary;

async function updateInvoiceSummary() {
  try {
    const res = await fetch(`${API_URL}/api/data`);
    const data = await res.json();
    const { students, sessions } = data;

    let totalAmount = 0;
    let sentCount = 0;
    let pendingCount = 0;

    students.forEach(student => {
      const studentSessions = sessions.filter(s => s.studentId === student.id);

      if (!studentSessions.length || !student.parentEmail) {
        pendingCount++;
        return;
      }

      let studentTotal = 0;

      studentSessions.forEach(s => {
        const mode = (s.mode || '').toLowerCase();
        const rate = mode.includes('individ') ? RATE_INDIVIDUAL : RATE_GROUP;
        const amount = s.cancelled
          ? rate * s.hours * CANCELLATION_FRACTION
          : rate * s.hours;

        studentTotal += amount;
      });

      totalAmount += studentTotal;

      // Check if PDF already exists on server:
      if (student.invoiceSent) sentCount++;
      else pendingCount++;
    });

    document.getElementById('total-amount').textContent = fmt(totalAmount);
    document.getElementById('sent-count').textContent = sentCount;
    document.getElementById('pending-count').textContent = pendingCount;

  } catch (err) {
    console.error(err);
    alert("Kon nie opsomming opdateer nie.");
  }
}
</script>
</body>
</html>



 


